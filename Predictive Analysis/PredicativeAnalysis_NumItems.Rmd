---
title: "InstaCart Predictive Analysis: Number of Items (Danny)"
author: "April Leclair, Daniel Ochoa, Hoang Anh Thai Vu, Qiuhan Sun"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "PredictiveAnalysis_HTML_Output") })
output:
  bookdown::tufte_html2:
    number_sections: no
    split_by: none
    toc: no
  bookdown::html_document2:
    number_sections: no
    split_by: none
    toc: no
  bookdown::tufte_handout2:
    latex_engine: xelatex
    number_sections: no
    toc: no
---

```{r echo=FALSE, message=FALSE}
library(tidyverse)
library(tree)
```

This file is used to predict how many items a user will order on their next order

# Reading In The Data
```{r message=FALSE, warning=FALSE }
orders <- read_csv("../Source/prior_orders_sample40k.csv") %>%
  mutate(order_dow = as.character(recode(order_dow, `0`="Sunday", `1`="Monday", `2`="Tuesday",
                            `3`="Wednesday", `4`="Thurday", `5`="Friday", `6`="Saturday"))) %>%
  filter(!is.na(days_since_prior_order))
order_products <- read_csv("../Source/prior_order_products_sample40k.csv")
```

# Preparing the Data

Below we create a num_products variable for the total number of products ordered in each order.
```{r}
orders <-
  order_products %>%
  group_by(order_id) %>%
  summarise(num_products = n()) %>%
  right_join(orders, by="order_id")
```

Below we create a avg_num_products variable for the average number of products this user orders.
```{r}
orders <-
  orders %>%
  group_by(user_id) %>%
  mutate(avg_num_products = mean(num_products))
```

Previous Order num_products variable
```{r}
orders <-
  orders %>%
  group_by(user_id) %>%
  mutate(previous_num_products = dplyr::lag(num_products, order_by=user_id))
```


Once we have sampled our training and test datasets we can move on to making predictions.
```{r echo=FALSE}
set.seed(7)  # Allows for reproducable sample results
random_users <- sample(unique(orders$user_id), 4000)  #4000 users are randomly chosen (~10% sample)

ordersTest <-
  subset(orders, user_id %in% random_users)
ordersTrain <- setdiff(orders, ordersTest)

ordersTest <-
  ordersTest %>%
  select(user_id, order_id, order_number, num_products, previous_num_products, avg_num_products, order_dow, order_hour_of_day, days_since_prior_order)
ordersTrain <-
  ordersTrain %>%
  select(user_id, order_id, order_number, num_products, previous_num_products, avg_num_products, order_dow, order_hour_of_day, days_since_prior_order)
```

# Making Predictions

```{r echo=FALSE}
singleTree <- tree(num_products ~ days_since_prior_order+avg_num_products+previous_num_products, ordersTrain)
plot(singleTree)
text(singleTree, pretty=1)
```



