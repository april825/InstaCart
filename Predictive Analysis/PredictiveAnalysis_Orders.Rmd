---
title: "InstaCart Predictive Analysis: Predicting Orders"
author: "April Leclair, Daniel Ochoa, Hoang Anh Thai Vu, Qiuhan Sun"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "PredictiveAnalysis_HTML_Output") })
output:
  bookdown::tufte_html2:
    number_sections: no
    split_by: none
    toc: no
  bookdown::html_document2:
    number_sections: no
    split_by: none
    toc: no
  bookdown::tufte_handout2:
    latex_engine: xelatex
    number_sections: no
    toc: no
---

```{r echo=FALSE, message=FALSE}
library(tidyverse)
library(xgboost)
library(Ckmeans.1d.dp) # Used for XGBoost visualization
library(DiagrammeR) # Used for XGBoost visualization
```

This file is used to predict what products a user will order next

# Reading In The Data
```{r message=FALSE, warning=FALSE }
train <- read_csv("../Source/trainingData.csv")
test <- read_csv("../Source/testingData.csv")
products <- read_csv("../Source/products.csv")  # Used to provide product names (hasn't been incorporated yet)
```

```{r}
set.seed(567)
sampleTrain <- train %>% 
   sample_frac(0.1)

crossVal <- train %>%
  filter(!order_id %in% sampleTrain$order_id)
```


# Predictions

```{r}
independents <- sampleTrain %>% 
  select(-reordered)

trainingMatrix <- xgb.DMatrix(as.matrix(independents), label = sampleTrain$reordered)
model <- xgboost(data = trainingMatrix, objective="binary:logistic", nrounds = 80, verbose=0)
importance <- xgb.importance(colnames(trainingMatrix), model = model)
xgb.ggplot.importance(importance)
```


```{r}
xgb.plot.tree(feature_names=colnames(independents), model=model, n_first_tree=1)
```

We can see from this which features are the most important. It is no suprie that user_product.orders is very important but we were surpised to find that user.numOrders is very important too. We will investigate this in the future.

```{r}
testMatrix <- xgb.DMatrix(as.matrix(test))
test$reordered <- predict(model, testMatrix)
test$reordered <- (test$reordered > 0.20) * 1 # 0.20 is random threshold I came up with, experiment with it (seems to move around)
```

```{r}
crossValMatrix <- xgb.DMatrix(as.matrix(crossVal))
crossVal$reordered <- predict(model, crossValMatrix)
crossVal$reordered <- (crossVal$reordered > 0.20) * 1 # 0.20 is random threshold I came up with, experiment with it
```

## Prediction Accuracy

Lets picture the accuracy of predictions
```{r}
crossVal_ex <- crossVal %>%
  filter(order_id == 1725556) %>%
  mutate(predictedToOrder = reordered) %>%
  select(product_id, predictedToOrder)

order_products_ex <- order_products_train %>%
  filter(order_id == 1725556) %>%
  mutate(actuallyOrder = 1) %>%
  select(product_id, actuallyOrder)

prediction_table <- order_products_ex %>%
  full_join(crossVal_ex, by="product_id")
  
prediction_table <- replace(prediction_table,is.na(prediction_table),0)
prediction_table <- prediction_table %>%
  mutate(accuracy = actuallyOrder - predictedToOrder) %>%
  select(product_id, accuracy)

ggplot(data=prediction_table, aes(x=product_id, y=accuracy)) + geom_point(aes(color=accuracy))
```

We can see from this graphic that the model was able to correctly predict some of the products that the order would contain. However, the model also predicts some products that the user did not order, in addition the model fails to predict a number of products that the user did in fact order.